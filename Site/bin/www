#!/usr/bin/node

var config = require('../libs/config');
var log = require('../libs/log');

if (process.env.NODE_ENV === 'production') {
    var cluster = require('cluster');
    var numCPUs = require('os').cpus().length;

    if (cluster.isMaster) {
        for (var i = 0; i < numCPUs; i++) {
            cluster.fork();
        }

        cluster.on('exit', function (worker) {
            log.info('worker ' + worker.process.pid + ' died');
            cluster.fork();
        });

        log.info('Server running at http://localhost:' + config.get('port'));
    } else {
        var app = require('../app');
        app.listen(config.get('port'), function () {
            log.info('Worker ' + cluster.worker.id + ' running!');
        });
    }

} else {
    var app = require('../app');
    app.listen(config.get('port'), function () {
        console.log('Server running at http://localhost:' + config.get('port'));
    });
}